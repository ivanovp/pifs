%\documentclass[a4paper,10pt,hungarian]{report}
%\documentclass[a4paper,10pt,hungarian]{article}
\documentclass[a4paper,10pt]{article}
%a ,,hungarian'' opció csak a draftcopy csomaghoz kell!
%\usepackage[latin2]{inputenc}
%\usepackage[T1]{fontenc}
%\usepackage[magyar]{babel}
%\usepackage[left=2.5cm,right=2.5cm,top=2cm,bottom=2cm]{geometry}
\usepackage[left=2.5cm,right=2cm,top=2cm,bottom=2cm]{geometry}
\usepackage{indentfirst}
\usepackage{upgreek}
\usepackage{relsize}
\usepackage{hyperref}
\usepackage{ifthen}
\usepackage{scrextend}
\addtokomafont{labelinglabel}{\sffamily}
\usepackage{tikz}
\usetikzlibrary{calc,fit,arrows,positioning}
\sloppy
%\usepackage{graphicx}
%\usepackage{ifthen}
%\usepackage{multicol}
%\usepackage[outline]{draftcopy} %outline,bottom,light,none/first/firsttwo
%\usepacgake{wasysym}
%%%% Don't modify next two line! %%%%
%.PDF.\usepackage{times}
%.PDF.\usepackage[T1]{mathtime}
\frenchspacing
\newcommand{\mypi}{{\larger $\uppi$}}
%\newcommand{\mypi}{{\larger $\pi$}}
\newcommand{\pifs}{\mypi{}fs}
\newcommand{\pifsl}{Pi file system}

%%% TiKZ
\tikzstyle{block} = [draw,fill=yellow!20,dashed,minimum size=7em,inner sep=0.45cm]
\tikzstyle{page} = [draw,fill=brown!25,dashed,minimum width=5em,minimum height=2.5em]
\tikzstyle{flash} = [draw,fill=gray!15,inner sep=0.45cm]
% diameter of semicircle used to indicate that two lines are not connected
\def\radius{.7mm} 
\tikzstyle{branch}=[fill,shape=circle,minimum size=3pt,inner sep=0pt]
\makeatletter
\tikzset{
    dot diameter/.store in=\dot@diameter,
    dot diameter=2pt,
    dot spacing/.store in=\dot@spacing,
    dot spacing=8pt,
    dots/.style={
        line width=\dot@diameter,
        line cap=round,
        dash pattern=on 0pt off \dot@spacing
    }
}
\makeatother
% Define layers, otherwise gray blocks will hide pages
\pgfdeclarelayer{background}
\pgfdeclarelayer{background2}
\pgfsetlayers{background,background2,main}
%%% End of TiKZ

\author{Peter Ivanov \textless{}ivanovp@gmail.com\textgreater{}}
\title{\pifsl{} (\pifs{})}
%%
%\usepackage[dvips]{graphicx}

%%

\begin{document}
\maketitle
%\tableofcontents
\section{Introduction}
This file system was developed for embedded systems which use NOR flash as 
storage. 
The development started as teach-myself project and I released the code in 
hope that it will be useful for someone else as well.

NOR flash ICs have very low price nowadays (2017) and can be used
to store files. But there are few problems to consider when designing a file
system:
\begin{itemize}
\item NOR flashes can be programmed (set bits to zero) by pages, but only 
can be erased (set bits to one) in a larger quantity, which are mostly called
block in the datasheets. One page is usually 256 or 512 bytes, one block 
consits of 16, 256, 1024, etc. pages. So typical block sizes are 4 KiB, 
64 KiB, 256 KiB.
\item Blocks can be erased ~10,000--100,000 times. After that data retention is 
not guaranteed. Therefore all blocks should be erased uniformly. This method 
is called wear leveling.
\end{itemize}

\pifs{} can be scaled from 4 Mbit (512 KiB), 256 Mbit (32 MiB), 
theoretically up to 1 Gbit (128 MiB) memory sizes.

\subsection{Features of the \pifs{}}
\begin{itemize}
\item Small memory footprint
\item Files can be opened for update ("r+", "w+", "a+" modes are supported)
\item Size of logical page is user-defined
\item Cache buffer for page (currently only one page is cached)
\item Directory handling
\item Dynamic wear-leveling
\item Static wear-leveling (limited, work-in-progress)
\item User data can be added for files: permissions, owner IDs, etc.
\item At the beginning of flash memory reserved blocks can be defined, which 
are not used by the file system
\end{itemize}

\subsection{Limitations of the \pifs{}}
\begin{itemize}
\item Only one flash chip can be used (one volume is supported)
\item Memory and file system configuration cannot be changed during run-time
\item One directory can only store pre-defined number of files or directories
\item Incompatible with FAT file system, therefore cannot be used for USB mass
storage devices
\end{itemize}

\section{Definitions, Acronyms and Abbreviations}
\begin{labeling}{Management area} % <--- here goes the longest definition to measure the necessary space
\item[NOR flash] Special type of EEPROMs, which manufactured using NOR gates.

\item[Page] Array of several bytes in the flash memory. Number of bytes is power of two, usually 256 or 512 bytes. See \autoref{fig:flash}.

\item[Block] Composed of several pages. Usually a block contain 16, 256 or 1024 
pages. See \autoref{fig:flash}.

\item[Erase] Change data bits to one (logical high level). Only a whole block can be erased, which means all bits of the block are set to one.

\item[Program] Change data bits to zero (logical low level). Each bit of a page can be programmed individually.

\item[Block address] Index of block in flash memory. Type: pifs\_block\_address\_t

\item[Page address] Index of a page in a block. Type: pifs\_page\_address\_t

\item[Page offset] Index of a byte in a page. Type: pifs\_page\_offset\_t

\item[Data area] Blocks which hold the file's content.

\item[Management area] Blocks which hold the file system's internal
data, how much space is allocated, where are the data pages of files, etc.

\item[Map page] Management page which is used to describe data pages of a file.

\item[Entry list] Technically a directory of file system.

\item[Entry] One file or directory in the directory.

\item[TBR] To be released. A page which was used, but now it can erased then 
allocated.
\end{labeling}

\begin{figure}[h]
\centering
\input{flash_fig}
\caption{Flash memory layout}
\label{fig:flash}
\end{figure}

\begin{figure}[h]
\centering
\input{flash_fs_fig}
\caption{Flash memory layout when \pifs{} installed}
\label{fig:flash_fs}
\end{figure}

\end{document}
